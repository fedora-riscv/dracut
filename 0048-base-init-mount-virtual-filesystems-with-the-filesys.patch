From 9ff9165103f365e0e33c3fc11b5a8b70a7b15575 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Fri, 17 Jun 2011 13:14:18 +0200
Subject: [PATCH] base/init: mount virtual filesystems with the filesystem
 type as source

Conflicts:

	modules.d/99base/init
---
 modules.d/99base/init |   13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/modules.d/99base/init b/modules.d/99base/init
index ceb3619..d306fda 100755
--- a/modules.d/99base/init
+++ b/modules.d/99base/init
@@ -78,8 +78,11 @@ RDDEBUG=""
 [ -c /dev/null ] || mknod -m 0666 /dev/null c 1 3
 
 # mount some important things
-mount -t proc -o nosuid,noexec,nodev /proc /proc >/dev/null 2>&1
-mount -t sysfs -o nosuid,noexec,nodev /sys /sys >/dev/null 2>&1
+[ ! -d /proc/self ] && \
+    mount -t proc -o nosuid,noexec,nodev proc /proc >/dev/null 2>&1
+
+[ ! -d /sys/kernel ] && \
+    mount -t sysfs -o nosuid,noexec,nodev sysfs /sys >/dev/null 2>&1
 
 if [ -x /lib/systemd/systemd-timestamp ]; then
     RD_TIMESTAMP=$(/lib/systemd/systemd-timestamp)
@@ -90,9 +93,9 @@ fi
 
 if [ ! -c /dev/ptmx ]; then
     # try to mount devtmpfs
-    if ! mount -t devtmpfs -o mode=0755,nosuid udev /dev >/dev/null 2>&1; then
+    if ! mount -t devtmpfs -o mode=0755,nosuid,noexec devtmpfs /dev >/dev/null 2>&1; then
         # if it failed fall back to normal tmpfs
-        mount -t tmpfs -o mode=0755,nosuid udev /dev >/dev/null 2>&1 
+        mount -t tmpfs -o mode=0755,nosuid tmpfs /dev >/dev/null 2>&1
         # Make some basic devices first, let udev handle the rest
         mknod -m 0666 /dev/null c 1 3
         mknod -m 0666 /dev/ptmx c 5 2
@@ -110,7 +113,7 @@ mkdir -p -m 0755 /dev/shm /dev/pts /run
 mount -t devpts -o gid=5,mode=620,noexec,nosuid devpts /dev/pts >/dev/null 2>&1
 mount -t tmpfs -o mode=1777,nosuid,nodev  tmpfs /dev/shm >/dev/null 2>&1
 # create /run which will obsolete /var/run
-mount -t tmpfs -o mode=0755,nodev,noexec,nosuid tmpfs /run >/dev/null 2>&1
+mount -t tmpfs -o mode=0755,nosuid,nodev tmpfs /run >/dev/null 2>&1
 
 mkdir -m 0755 /run/initramfs
 
-- 
1.7.9.3

