From 71e1f085cceb5023661ab6c5bdd147a0f2a92b5c Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Mon, 29 Aug 2011 19:12:12 +0200
Subject: [PATCH] 99base/init: only poll cdroms, if the kernel does support
 autopolling

---
 modules.d/99base/init |   34 +++++++++++++++-------------------
 1 file changed, 15 insertions(+), 19 deletions(-)

diff --git a/modules.d/99base/init b/modules.d/99base/init
index b61680a..dc2cdfa 100755
--- a/modules.d/99base/init
+++ b/modules.d/99base/init
@@ -201,7 +201,8 @@ getarg 'rd.break=pre-trigger' 'rdbreak=pre-trigger' && emergency_shell -n pre-tr
 source_hook pre-trigger
 
 # then the rest
-udevadm trigger --action=add $udevtriggeropts  >/dev/null 2>&1
+udevadm trigger --type=subsystems --action=add >/dev/null 2>&1
+udevadm trigger --type=devices --action=add >/dev/null 2>&1
 
 getarg 'rd.break=initqueue' 'rdbreak=initqueue' && emergency_shell -n initqueue "Break before initqueue"
 
@@ -242,25 +243,20 @@ while :; do
     # no more udev jobs and queues empty.
     sleep 0.5
 
-    # dirty hack for some cdrom drives,
-    # which report no medium for quiet
-    # some time.
-    for cdrom in /sys/block/sr*; do
-        [ -e "$cdrom" ] || continue
-        # skip, if cdrom medium was already found
-        strstr "$(udevadm info --query=env --path=${cdrom##/sys})" \
-            ID_CDROM_MEDIA && continue
-
-        if [ -e "$cdrom"/events_poll_msecs -a ! -e "/tmp/.poll_${cdrom##*/}" ]; then
-            msecs=$(while read a; do echo $a;done < "$cdrom"/events_poll_msecs)
-            if [ "$msecs" = "-1" ]; then
-                echo 250 > "$cdrom"/events_poll_msecs
-                > "/tmp/.poll_${cdrom##*/}"
-            fi
-        else
+    if [ ! -e /sys/module/block/parameters/uevent ]; then
+        # if the kernel does not support autopolling
+        # then we have to do a
+        # dirty hack for some cdrom drives,
+        # which report no medium for quiet
+        # some time.
+        for cdrom in /sys/block/sr*; do
+            [ -e "$cdrom" ] || continue
+            # skip, if cdrom medium was already found
+            strstr "$(udevadm info --query=env --path=${cdrom##/sys})" \
+                ID_CDROM_MEDIA && continue
             echo change > "$cdrom/uevent"
-        fi
-    done
+        done
+    fi
 
     if [ $main_loop -gt $(($RDRETRY/2)) ]; then
 	for job in $hookdir/initqueue/timeout/*.sh; do
