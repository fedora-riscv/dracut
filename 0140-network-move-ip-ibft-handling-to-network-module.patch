From 73833796b4592b06777fa1991163b74e9bb1e477 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Thu, 3 Sep 2015 12:41:44 +0200
Subject: [PATCH] network: move "ip=ibft" handling to network module

(cherry picked from commit b334c83e4abdc1dd87276fa7de4617cd349a5a4f)
---
 modules.d/40network/parse-ibft.sh                  | 2 ++
 modules.d/90kernel-network-modules/module-setup.sh | 1 +
 modules.d/95iscsi/parse-iscsiroot.sh               | 2 +-
 3 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/modules.d/40network/parse-ibft.sh b/modules.d/40network/parse-ibft.sh
index 144e205..8895b04 100755
--- a/modules.d/40network/parse-ibft.sh
+++ b/modules.d/40network/parse-ibft.sh
@@ -4,5 +4,7 @@ command -v getarg >/dev/null          || . /lib/dracut-lib.sh
 command -v ibft_to_cmdline >/dev/null || . /lib/net-lib.sh
 
 if getargbool 0 rd.iscsi.ibft -d "ip=ibft"; then
+    modprobe -b -q iscsi_boot_sysfs 2>/dev/null
+    modprobe -b -q iscsi_ibft
     ibft_to_cmdline
 fi
diff --git a/modules.d/90kernel-network-modules/module-setup.sh b/modules.d/90kernel-network-modules/module-setup.sh
index b956ebe..18d7d96 100755
--- a/modules.d/90kernel-network-modules/module-setup.sh
+++ b/modules.d/90kernel-network-modules/module-setup.sh
@@ -62,6 +62,7 @@ installkernel() {
         =drivers/net/team \
         =drivers/net/ethernet \
         ecb arc4 bridge stp llc ipv6 bonding 8021q af_packet virtio_net
+    hostonly="" instmods iscsi_ibft crc32c iscsi_boot_sysfs
 }
 
 # called by dracut
diff --git a/modules.d/95iscsi/parse-iscsiroot.sh b/modules.d/95iscsi/parse-iscsiroot.sh
index 81be6a9..63a822f 100755
--- a/modules.d/95iscsi/parse-iscsiroot.sh
+++ b/modules.d/95iscsi/parse-iscsiroot.sh
@@ -69,7 +69,7 @@ if [ -n "$iscsiroot" ] ; then
 fi
 
 # iscsi_firmware does not need argument checking
-if [ -n "$iscsi_firmware" ] || getargbool 0 rd.iscsi.ibft -d "ip=ibft"; then
+if [ -n "$iscsi_firmware" ]; then
     if [ "$root" != "dhcp" ] && [ "$netroot" != "dhcp" ]; then
         [ -z "$netroot" ] && netroot=iscsi:
     fi
