From 12eec3dc5a02d33de9d3827ed1508eaa4c527683 Mon Sep 17 00:00:00 2001
From: Harald Hoyer <harald@redhat.com>
Date: Wed, 22 Aug 2012 13:01:53 +0200
Subject: [PATCH] mdraid: catch nested md raids

Thanks to Ian Dall!
---
 modules.d/90mdraid/65-md-incremental-imsm.rules | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/modules.d/90mdraid/65-md-incremental-imsm.rules b/modules.d/90mdraid/65-md-incremental-imsm.rules
index c4334db..d66dd01 100644
--- a/modules.d/90mdraid/65-md-incremental-imsm.rules
+++ b/modules.d/90mdraid/65-md-incremental-imsm.rules
@@ -5,7 +5,11 @@
 ACTION!="add|change", GOTO="md_end"
 SUBSYSTEM!="block", GOTO="md_end"
 ENV{rd_NO_MD}=="?*", GOTO="md_end"
-KERNEL=="md*", GOTO="md_end"
+KERNEL=="md*", ENV{ID_FS_TYPE}!="linux_raid_member", GOTO="md_end"
+KERNEL=="md*", ACTION!="change", GOTO="md_end"
+
+# Also don't process disks that are slated to be a multipath device
+ENV{DM_MULTIPATH_DEVICE_PATH}=="?*", GOTO="md_end"
 
 ENV{ID_FS_TYPE}=="ddf_raid_member|isw_raid_member|linux_raid_member", GOTO="md_try"
 GOTO="md_end"
